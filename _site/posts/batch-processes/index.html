<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Parallel processes in batch mode « alvaro carril blog</title>
  <meta name="description" content="One of the most powerful features of batch mode is the ability to run several processes in parallel. I’ll explain how to easily use this feature  with Stata.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://acarril.github.io/posts/batch-processes">
  <link rel="alternate" type="application/rss+xml" title="alvaro carril blog" href="http://acarril.github.io/feed.xml" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/academicons.css" />
  <script type="text/javascript" src='/js/Statax.js'></script>
  <!-- <script type="text/javascript" src='http://haghish.com/statax/Statax.js'></script> -->
  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54241026-2', 'auto');
  ga('send', 'pageview');

</script>
</head>


  <body>

    <header class="header">
  <div class="wrapper">
    <a class="site-title" href="/">alvaro carril blog</a>
    <nav class="site-nav">
      
        
      
        
        <a class="page-link" href="/about/">about</a>
        
      
        
        <a class="page-link" href="/posts/categories">posts</a>
        
      
        
      
        
      
        
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Parallel processes in batch mode</h1>
    <p class="post-meta">Apr 20, 2016</p>
  </header>

  <article class="post-content">
    <p>One of the most powerful features of batch mode is the ability to run several processes in parallel. I’ll explain how to easily use this feature  with Stata.</p>

<p>This is the second post regarding batch jobs in the RCE server. I also wrote a <a href="batch-jobs">first part</a> which deals with the basics of running batch jobs using Stata.</p>

<h1 id="stuff-needed">Stuff needed</h1>

<p>We are going to need, as usual, a <a href="#do-file"><strong>do-file</strong></a> and a <a href="#submit-file"><strong>submit file</strong></a>. We are also going to assume some basic <a href="#directory-structure"><strong>directory structure</strong></a>.</p>

<h3 id="directory-structure">Directory structure</h3>

<p>For this example we’ll need to set everything up in a root folder which contains a <code>dofiles</code> folder, a <code>batch_output</code> folder and a <code>datasets</code> folder. The do-file to submit is going to be located inside the dofiles folder, while the submit file is located in the root folder. All this can be easily seen in the screenshot below.</p>

<p><img src="..\files\batch_process_directory_structure.png" alt="batch_process_directory_structure" /></p>

<h3 id="do-file">Do-file</h3>

<p>The do-file we’re using is going to</p>

<ol>
  <li>Always read the same dataset</li>
  <li>Set a different seed for each process</li>
  <li>Extract a different sample with replacement for each process</li>
  <li>Compute the average value of a variable from the sampled observations for each process</li>
  <li>Save a different collapsed dataset for each process</li>
</ol>

<p>The key here is to collect <code>process</code>, an integer passed by the submit file (see the <a href="#submit-file">submit file</a> below) onto the do-file. This will make each run of the do-file unique for each process.</p>

<pre class="sh_stata">
// set more off so that the do-file runs without halting
set more off

// collect the arguments passed by submit file
args process

// load example dataset
sysuse bpwide, clear

// set seed so it's different for every process
set seed `process'

// sample with replacement
bsample, cluster(patient) idcluster(idcluster)

// calculate the mean and standard deviation
collapse (mean) mean_bp_before = bp_before (sd) sd_bp_before = bp_before

// save the result, appending the process number to the dataset name
save "datasets/output_`process'.dta", replace
</pre>

<h3 id="submit-file">Submit file</h3>

<p>The submit file is very similar to the basic template, but now we pass the <code>Process</code> argument from the batch system onto Stata, by defining a global (remeber our do-file expects that?). The way to do that is by appending <code>$(Process)</code> at the end of the <code>Arguments</code> line. The process number should also be appended to the <code>ouptut</code>, <code>error</code> and <code>log</code> files, like below.</p>

<p>How many process we are requesting is defined in the last line, <code>Queue</code>. In this example we’re requesting 10 processes, which will make the <code>$(Process)</code> integer go from 0 to 9.</p>

<pre><code class="language-c">Universe = vanilla
Executable = /usr/local/bin/stata-mp

# Pass the process number, which will be used
# to append the process number to the output files.
Arguments = -q do dofiles/batch_process.do $(Process)

output = batch_output/mydofile$(Process).out
error = batch_output/mydofile$(Process).err
Log = batch_output/mydofile$(Process).log

Request_Cpus = 2
Request_Memory = 2GB

# Notifications settings
notification = Always
notify_user = your@email.com

# Number of processes to request
Queue 10
</code></pre>

<h1 id="running-the-processes">Running the processes</h1>

<p>To submit these parallel jobs we’ll go to the command line and change the current directory to our root folder. For example, I have put all the files of this example in a folder called <code>batch</code>, located inside my personal directory in the RCE environment, so I use</p>

<pre><code>cd batch
condor_submit stata_batch_process.submit
</code></pre>

  </article>
  
  

<div class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'acarril'; // required: replace example with your forum shortname
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</div>




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://avatars3.githubusercontent.com/u/9773292?v=3&s=460" alt="Alvaro Carril">
  <div class="col-box-title name">Alvaro Carril</div>
  <p>Economist / Research analyst at J-PAL</p>
  <p class="contact">
    
    <a href="https://github.com/acarril"><i class="fa fa-github fa-2x"></i></a>
    
    
    <a href="https://www.researchgate.net/profile/Alvaro_Carril"><i class="ai ai-researchgate-square ai-2x"></i></a>
    
    
    <a href="http://twitter.com/alvcarril"><i class="fa fa-twitter fa-2x"></i></a>
    
    
    <a href="mailto:acarril@fen.uchile.cl"><i class="fa fa-envelope fa-2x"></i></a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Recent Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/posts/batch-processes">Parallel processes in batch mode</a></li>
    
      <li><a class="post-link" href="/posts/batch-jobs">Batch Jobs</a></li>
    
      <li><a class="post-link" href="/posts/column-percentages-tabstat">Adding column percentages of sums to tabstat</a></li>
    
      <li><a class="post-link" href="/posts/prob-false-positives">On the probability of false positives</a></li>
    
      <li><a class="post-link" href="/posts/slutsky">Slutsky matrix times price vector</a></li>
    
  </ul>
</div>
<!--
<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>
-->

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2016 Alvaro Carril
</div>
</footer>

<script src="/js/easybook.js"></script>

  </body>

</html>
